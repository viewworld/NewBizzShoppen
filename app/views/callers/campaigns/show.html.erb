<column-mc:>

  <search-box:>
    <div class="search_box">
      <h2><%= t("campaigns.show.search_label") %></h2>

      <div class="search_content">

        <%= semantic_form_for @search, :url => callers_campaign_path(@campaign) do |f| %>
            <fieldset class="inputs_vertical grid_150 fltl">
              <ol class="no_pdd">
                <li class="select">
                  <%= label_tag t("campaigns.show.search.agents") %>
                  <%= select_tag :agent_ids, options_from_collection_for_select(@campaign.users, "id", "full_name", @agent_ids), :multiple => true, :style => "height:80px;width:140px;" %>
                </li>
              </ol>
            </fieldset>

            <div class="fltl">

              <fieldset class="inputs_vertical">
                <ol class="no_pdd">
                  <li class="date">
                    <%= label_tag t("campaigns.show.search.date_from") %>
                    <%= text_field_tag :date_from, @date_from, :class => "datepicker" %>
                  </li>
                  <li class="date">
                    <%= label_tag t("campaigns.show.search.date_to") %>
                    <%= text_field_tag :date_to, @date_to, :class => "datepicker" %>
                  </li>
                  <li class="boolean">
                    <%= check_box_tag :final, "yes", @final %>
                    <%= label_tag :final, t("campaigns.show.search.final") %>
                  </li>
                  <li class="commit">
                    <ibt c="bt_green" icon="magnify">
                      <%= submit_tag t("campaigns.show.search_button") %>
                    </ibt>
                  </li>
                </ol>
              </fieldset>

              <br/>

              <p class="pdd_10 no_pdd_tb" style="margin-top:-8px;">
                <%= t("campaigns.show.ranges_label") %>:<br/>
                <%= link_to_function t("campaigns.show.ranges.whole_campaign"), "$('#date_from').val('#{@campaign.start_date}');$('#date_to').val('#{@campaign.end_date}')" %>
                <%= link_to_function t("campaigns.show.ranges.this_month"), "$('#date_from').val('#{Date.today.beginning_of_month}');$('#date_to').val('#{Date.today.end_of_month}')" %>
                <%= link_to_function t("campaigns.show.ranges.this_week"), "$('#date_from').val('#{Date.today.beginning_of_week}');$('#date_to').val('#{Date.today.end_of_week}')" %>
                <%= link_to_function t("campaigns.show.ranges.today"), "$('#date_from').val('#{Date.today}');$('#date_to').val('#{Date.today}')" %>
              </p>

            </div>

            <clb/>
        <% end %>
      </div>
    </div>
  </search-box:>

  <header back="true" backurl="#{callers_campaigns_path}"><%= @campaign.name %></header>

  <div class="frm_tiny pdd_10">

    <p>
      <%= t("campaigns.show.total_contacts") %>: <strong><%= @campaign.contacts.size %></strong>&nbsp;
      <%= t("campaigns.show.total_agents") %>: <strong><%= @campaign.users.size %></strong>&nbsp;
      <%= t("campaigns.show.total_calls") %>: <strong>??</strong>
    </p>
  </div>

  <table id="call_results" class="generic">
    <thead>
    <tr>
      <th class="hl"></th>
      <th><%= t("campaigns.show.table.results") %></th>
      <% @headers.each do |header| %>
          <th class="ta_r pointer"><%= header %></th>
      <% end %>
      <th class="ta_r pointer"><%= t("campaigns.show.table.sum") %></th>
      <th class="hr"></th>
    </tr>
    </thead>
    <tfoot>
    <tr>
      <td class="fl"></td>
      <td colspan="<%= @headers.size+2 %>"></td>
      <td class="fr"></td>
    </tr>
    </tfoot>
    <tbody>
    <% @results.each do |result| %>
        <tr class="<%= cycle("odd", "even") %>">
          <% rows = CallResult.for_table_row(@date_from, @date_to, [result.id], @agent_ids, @campaign.id) %>
          <td class="cl"></td>
          <td><%= result.name %></td>
          <% rows.each do |col| %>
              <td class="ta_r pointer" onclick="$('#call_result_ids').val('<%= col[:ids]*',' %>');$('#result_details_form').submit();"><%= col[:number] %></td>
          <% end %>
          <td class="ta_r pointer" onclick="$('#call_result_ids').val('<%= rows.inject([]){|acc, itm| acc += itm[:ids]}.uniq*',' %>');$('#result_details_form').submit();"><%= rows.map { |col| col[:number] }.sum %></td>
          <td class="cr"></td>
        </tr>
    <% end %>
    <tr class="<%= cycle("odd", "even") %>">
      <% result_row = CallResult.for_table_row(@date_from, @date_to, @results.map(& :id), @agent_ids, @campaign.id) %>
      <td class="cl"></td>
      <td><%= t("campaigns.show.table.all_results") %></td>
      <% result_row.each do |col| %>
          <td class="ta_r pointer" onclick="$('#call_result_ids').val('<%= col[:ids]*',' %>');$('#result_details_form').submit();"><%= col[:number] %></td>
      <% end %>
      <td class="ta_r pointer" onclick="$('#call_result_ids').val('<%= result_row.inject([]){|acc, itm| acc += itm[:ids]}.uniq*',' %>');$('#result_details_form').submit();"><%= result_row.map { |col| col[:number] }.sum %></td>
      <td class="cr"></td>
    </tr>
    </tbody>
  </table>

  <%= form_tag result_details_callers_campaign_path(@campaign), :method => :get, :id => "result_details_form", :remote => true do %>
      <%= hidden_field_tag :call_result_ids, "" %>
  <% end %>

  <div id="container_for_result_details"></div>

  <js:>
    <script type="text/javascript">
        $(function() {
            $(".datepicker").datepicker({ dateFormat: 'yy-mm-dd' });
        });
    </script>
  </js:>


</column-mc:>