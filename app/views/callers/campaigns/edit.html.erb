<column-mc:>
  <header back="true" backurl="#{callers_campaigns_path}"><%= t("campaigns.edit.title") %>: <%= @campaign.name %></header>

  <%= semantic_form_for [:callers, @campaign], :method => :put do |form| %>
      <frm title="Edit">
        <param:header>
          <%= bt_link_to nil, t("campaigns.edit.materials_repository"), callers_campaign_materials_path(@campaign), :class => "fltr" %>
          <%= bt_link_to nil, t("campaigns.edit.description_and_briefing"), edit_callers_campaign_campaigns_description_path(@campaign), :class => "fltr" %>

          <%= bt_link_to nil, t("campaigns.edit.results"), callers_campaign_path(@campaign), :class => "fltr" %>
          <%= bt_link_to nil, t("campaigns.edit.agent_assignment_button"), callers_campaign_campaigns_users_path(@campaign), :class => "fltr" %>
          <%= bt_link_to nil,  t("campaigns.edit.edit_template"),"javascript:void(0)", :onclick => "edit_template(#{@campaign.id})", :class => "fltr" %>
          <%= select_tag :email_template_id, options_for_select(@campaign.cloned_email_templates.map { |t| [t.name, t.id] }), { :class => "fltr" } %>
        </param:header>
        <param:content>
          <%= render :partial => '/callers/campaigns/form', :locals => {:form => form, :campaign => @campaign} %>
        </param:content>
        <param:actions>
          <ibt c="fltri" icon="save">
            <%= form.submit t("campaigns.edit.button_update"), :name => "commit_create" %>
          </ibt>
          <%= bt_link_to nil, t("campaigns.edit.button_cancel"), callers_campaigns_path, :class => "bt_grey fltr" %>
        </param:actions>
      </frm>
  <% end %>

  <br/>

  <header>
    <param:content>
      <%= t("campaigns.edit.title_contacts") %>
    </param:content>

    <param:actions>
      <%= form_tag administration_articles_path, :method => :post, :id => "form_new_article" do %>
          <ul class="header_actions">
            <li>
              <%= bt_link_to :plus, t("campaigns.edit.button_create_contact"), new_callers_campaign_contact_path(@campaign) %>
            </li>
            <li>
              <%= bt_link_to nil, t("campaigns.edit.production"), callers_production_path(:campaign_ids => [@campaign.id]) %>
            </li>
            <li>
              <%= bt_link_to nil, t("campaigns.edit.agent_work_screen_as"), "javascript:void();", :onclick => "go_to_agent_work_screen_as_user(#{@campaign.id})" %>
            </li>
            <li><%= select_tag :user_id, options_from_collection_for_select(current_user.admin? ? @campaign.users : [current_user]+@campaign.users.where(:id => current_user.subaccount_ids), 'id', 'screen_name') %></li>
            <li>
              <%= bt_link_to :users, t("campaigns.edit.button_import_contacts"), new_callers_campaign_contact_path(@campaign, :type => "import") %>
            </li>
            <li class="last">
              <%= bt_link_to :pencil, t("campaigns.edit.button_manage_result_types"), callers_campaign_results_path(@campaign) %>
            </li>

          </ul>
      <% end %>
    </param:actions>
  </header>

  <%= form_for @search, :url => edit_callers_campaign_path(@campaign) do |f| %>
      <p>
        <%= label_tag t("contacts.filter.keyword_label") %>
        <%= f.text_field :with_keyword %>
        <%= bt_link_to nil, t("contacts.filter.search_button"), "javascript:void(0)", :onclick => "$(this).parents('form').submit()" %>
      </p>
  <% end %>

  <%= contacts_table @contacts, :show_checkboxes => true do |blocks| %>
      <% blocks.tools do |contact| %>
          <ul-actions>
            <li>
              <%= link_to t("campaigns.edit.edit_button"), edit_callers_campaign_contact_path(@campaign, contact), :class => "default_action" %>
            </li>
            <li>
              <%= link_to t("campaigns.edit.remove_button"), callers_campaign_contact_path(@campaign, contact), :confirm => t("campaigns.edit.remove_confirm"), :method => :delete %>
            </li>
          </ul-actions>
      <% end %>

      <% blocks.bottom do %>

          <% form_tag batch_assign_callers_campaign_contacts_path(@campaign), :method => :post, :id => "batch_assign_form" do %>
              <%= select_tag "agent_id", options_for_select(@campaign.users.map { |u| [u.screen_name, u.id] }) %>
              <%= hidden_field_tag "contact_ids", nil, :id => "hf_batch_assign" %>
              <%= bt_link_to :users, t("campaigns.edit.button_assign_selected_contacts"), "javascript:void(0)", :onclick => "set_contacts_id_hf('hf_batch_assign');$('#batch_assign_form').submit();" %>
              <%= bt_link_to :remove, t("campaigns.edit.button_remove_selected"), "javascript:void(0)", :onclick => "set_contacts_id_hf('hf_batch_remove');$('#batch_remove_form').submit();" %>
              <%= bt_link_to :remove, t("campaigns.edit.button_remove_assignment_for_selected"), "javascript:void(0)", :onclick => "set_contacts_id_hf('hf_batch_unassign');$('#batch_unassign_form').submit();" %>
              <%= bt_link_to :download, t("campaigns.edit.button_bulk_download_csv_link"), bulk_contacts_export_csv_callers_campaign_contacts_path(@campaign), :method => :post, :class => "fltr" %>
          <% end %>

          <%= form_tag batch_assign_callers_campaign_contacts_path(@campaign), :method => :post, :id => "batch_unassign_form" do %>
              <%= hidden_field_tag "contact_ids", nil, :id => "hf_batch_unassign" %>
          <% end %>

          <%= form_tag batch_remove_callers_campaign_contacts_path(@campaign), :method => :post, :id => "batch_remove_form" do %>
              <%= hidden_field_tag "contact_ids", nil, :id => "hf_batch_remove" %>
          <% end %>
      <% end %>
  <% end %>
</column-mc:>

<js:>
  <script type="text/javascript">
    function edit_template(campaign_id)
    {
        if($('#email_template_id option:selected').val() != ''){
            window.location.href = '/callers/campaigns/' + campaign_id.toString() + '/email_templates/' + $('#email_template_id option:selected').val() + '/edit'
        }
    }

    function go_to_agent_work_screen_as_user(campaign_id){
        selected_user = $('#user_id option:selected').val();
        window.location.href = "/callers/campaigns/" + campaign_id.toString() + "/agent_work_screen?other_user_id=" + selected_user.toString();
    }
  </script>
</js:>