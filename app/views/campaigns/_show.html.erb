<header><%= campaign.name %></header>

<%= t("campaigns.show.total_contacts") %>: <%= campaign.contacts.size %>
<%= t("campaigns.show.total_agents") %>: <%= campaign.users.size %>
<%= t("campaigns.show.total_calls") %>: ??


<div class="search_box">
  <h2><%= t("campaigns.show.search_label") %></h2>

  <div class="search_content">
    <%= semantic_form_for search, :url => path do |f| %>
        <fieldset class="inputs_vertical">
          <ol class="no_pdd">
            <li class="string">
              <%= t("campaigns.show.ranges_label") %>:
              <%= link_to_function t("campaigns.show.ranges.whole_campaign"), "$('#date_from').val('#{campaign.start_date}');$('#date_to').val('#{campaign.end_date}')" %>
              <%= link_to_function t("campaigns.show.ranges.this_month"), "$('#date_from').val('#{Date.today.beginning_of_month}');$('#date_to').val('#{Date.today.end_of_month}')" %>
              <%= link_to_function t("campaigns.show.ranges.this_week"), "$('#date_from').val('#{Date.today.beginning_of_week}');$('#date_to').val('#{Date.today.end_of_week}')" %>
              <%= link_to_function t("campaigns.show.ranges.today"), "$('#date_from').val('#{Date.today}');$('#date_to').val('#{Date.today}')" %>
              <br/>
              <%= t("campaigns.show.search.date_from") %> <%= text_field_tag :date_from, date_from %>
              <%= t("campaigns.show.search.date_to") %> <%= text_field_tag :date_to, date_to %>
              <%= t("campaigns.show.search.agents") %> <%= select_tag :agent_ids, options_from_collection_for_select(campaign.users, "id", "full_name", agent_ids), :multiple => true, :style => "width:200px;height:60px;" %>
              <br/>
              <%= check_box_tag :final, "yes", final %> <%= t("campaigns.show.search.final") %>
            </li>
            <li class="commit">
              <ibt c="bt_green" icon="magnify">
                <%= submit_tag t("campaigns.show.search_button") %>
              </ibt>
            </li>
          </ol>
        </fieldset>
    <% end %>
  </div>
</div>

<table id="call_results" class="generic">
  <thead>
  <tr>
    <th class="hl"></th>
    <th><%= t("campaigns.show.table.results") %></th>
    <% headers.each do |header| %>
        <th><%= header %></th>
    <% end %>
    <th><%= t("campaigns.show.table.sum") %></th>
    <th class="hr"></th>
  </tr>
  </thead>
  <tfoot>
  <tr>
    <td class="fl"></td>
    <td colspan="<%= headers.size+2 %>"></td>
    <td class="fr"></td>
  </tr>
  </tfoot>
  <tbody>
  <% @results.each do |result| %>
      <tr class="<%= cycle("odd", "even") %>">
        <% rows = CallResult.for_table_row(date_from, date_to, [result.id], agent_ids, campaign.id) %>
        <td class="cl"></td>
        <td><%= result.name %></td>
        <% rows.each do |col| %>
            <td onclick="$('#call_result_ids').val('<%= col[:ids]*',' %>');$('#result_details_form').submit();"><%= col[:number] %></td>
        <% end %>
        <td onclick="$('#call_result_ids').val('<%= rows.inject([]){|acc, itm| acc += itm[:ids]}.uniq*',' %>');$('#result_details_form').submit();"><%= rows.map { |col| col[:number] }.sum %></td>
        <td class="cr"></td>
      </tr>
  <% end %>
  <tr class="<%= cycle("odd", "even") %>">
    <% result_row = CallResult.for_table_row(date_from, date_to, results.map(&:id), agent_ids, campaign.id) %>
    <td class="cl"></td>
    <td><%= t("campaigns.show.table.all_results") %></td>
    <% result_row.each do |col| %>
        <td onclick="$('#call_result_ids').val('<%= col[:ids]*',' %>');$('#result_details_form').submit();"><%= col[:number] %></td>
    <% end %>
    <td onclick="$('#call_result_ids').val('<%= result_row.inject([]){|acc, itm| acc += itm[:ids]}.uniq*',' %>');$('#result_details_form').submit();"><%= result_row.map { |col| col[:number] }.sum %></td>
    <td class="cr"></td>
  </tr>
  </tbody>
</table>

<%= form_tag path_for_js, :method => :get, :id => "result_details_form", :remote => true do %>
    <%= hidden_field_tag :call_result_ids, "" %>
<% end %>

<div id="container_for_result_details"></div>