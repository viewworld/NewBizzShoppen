  <header>

    <param:content>
      <%= @category_type == "LeadCategory" ? t("categories.index.view.header") : t("deal_categories.index.view.header") %>
    </param:content>

    <param:actions>
      <ul class="header_actions">
          <% if user_signed_in? and current_user.has_role?(:admin) %>
            <li class="last"><%= bt_link_to :plus, @category_type == "LeadCategory" ? t("administration.categories.index.view.new_category") : t("administration.categories.index.view.new_deal_category"), new_administration_category_path(:category_type => @category_type) %></li>
          <% end %>
           <% if @category_type == "LeadCategory" and (!user_signed_in? or (user_signed_in? and current_user.has_any_role?(:agent, :call_centre_agent, :purchase_manager, :customer, :lead_buyer))) %>
            <li class="last"><%= bt_link_to :plus, t("layout.main_menu.shared.category_request"), new_category_request_path %></li>
          <% end %>
      </ul>
    </param:actions>

  </header>

  <% if @category_type == "DealCategory" %>
      <%= all_categories_tree(:category_type => "deal", :category_label => lambda { |c| link_to "#{c.name}", "/categories/deals/#{c.cached_slug}?search[with_category]=#{c.id}" },
                              :ul_css_class => "vertical",
                              :after_category => lambda { |c|
                                  "<span class='total_leads'>(#{c.deals_count_for_user(current_user) == 0 ? t("layout.main_menu.shared.sold_out") : c.deals_count_for_user(current_user)})</span> #{link_to_view_deal_templates(c)}" +
                                    [].tap do |links|
                                      if user_signed_in? and current_user.has_role?(:admin)
                                        links << link_to(t("administration.categories.index.view.edit_link"), edit_administration_category_path(c))
                                        links << link_to(t("administration.categories.index.view.destroy_link"), administration_category_path(c),
                                                       :method  => :delete,
                                                       :confirm => I18n.t("common.confirmation")) if c.is_empty?
                                      end
                                  end.join(" | ").html_safe
                              }) %>
  <% else %>
      <%= all_categories_tree(:category_type => "lead", :category_label => lambda { |c| link_to "#{c.name}", "/categories/#{c.cached_slug}?search[with_category]=#{c.id}" },
                              :ul_css_class => "vertical",
                              :after_category => lambda { |c|
                                  "<span class='total_leads'>(#{c.leads_count_for_user(current_user) == 0 ? t("layout.main_menu.shared.sold_out") : c.leads_count_for_user(current_user)})</span> #{link_to_view_lead_templates(c)}" +
                                    [].tap do |links|
                                      if user_signed_in? and current_user.has_role?(:admin)
                                        links << link_to(t("administration.categories.index.view.edit_link"), edit_administration_category_path(c))
                                        links << link_to(t("administration.categories.index.view.destroy_link"), administration_category_path(c),
                                                       :method  => :delete,
                                                       :confirm => I18n.t("common.confirmation")) if c.is_empty?
                                      end
                                  end.join(" | ").html_safe
                              }) %>
  <% end %>
  <clb/>