<head:>
  <% if Rails.env != "test" %>
      <meta property="og:title" content="<%= @deal.header %>"/>
      <meta property="og:type" content="website"/>
      <meta property="og:url" content="<%= deal_url(:id => @deal.slug) %>"/>
      <meta property="og:image" content="<%= path_to_image("logo_fairleads_with_border.jpg") %>"/>
      <meta property="og:site_name" content="Fairleads"/>
      <meta property="og:description" content="<%= (@deal.group_deal? and !@deal.social_media_description.blank?) ? @deal.social_media_description : @deal.description %>">
      <meta property="fb:app_id" content="198584516868482"/>
  <% end %>
  <%= javascript_include_tag "jquery.lwtCountdown-1.0" %>
  <%= stylesheet_link_tag "countdown" %>
  <%= javascript_include_tag "global_template_editor" %>
  <%= javascript_include_tag "global_field_validator" %>
</head:>

<column-mc:>
  <div class="deal_show_wrapper">
    <header back="true"><%= @deal.header %><%= ratings_for(@deal, :force_static => !current_user_has_role?(:member)) %></header>

    <div class="column_2to3">
      <div class="element_description">
        <h2></h2>

        <% if user_signed_in? and current_user.has_role?(:member) and @deal.requested_by?(current_user) and @deal.deal_confirmation_page %>
            <h3><%= t("deals.show.view.confirmation_page_label") %></h3>

            <p><%= @deal.deal_confirmation_page.to_s.html_safe %></p>
        <% end %>

        <% if user_signed_in? and current_user.has_role?(:member) and @deal.requested_by?(current_user) and @deal.deal_code.present? %>
            <h3><%= t("deals.show.view.deal_code_label") %></h3>

            <p><%= @deal.deal_code_is_url? ? link_to(@deal.deal_code, @deal.deal_code_as_url) : @deal.deal_code %></p>
        <% end %>

        <h3><%= t("deals.show.view.short_description_label") %></h3>

        <p><%= raw @deal.description %></p>

        <h3><%= t("deals.show.view.detailed_description_label") %></h3>

        <p><%= @deal.hidden_description.to_s.html_safe %></p>

        <h3><%= t("deals.show.view.fine_print_label") %></h3>

        <p><%= @deal.fine_print.to_s.html_safe %></p>

        <% unless @deal.images.blank? %>
            <h3><%= t("deals.show.view.images_label") %></h3>

            <p>
              <% @deal.images.each do |image| %>
                  <%= link_to image_tag(image.url(:original), :class => "thumb"), image.url, :rel => "colorbox" %>
              <% end %>
            </p>
        <% end %>

        <% unless @deal.materials.blank? %>
            <h3><%= t("deals.show.view.materials_label") %></h3>

            <p>
              <% @deal.materials.each do |material| %>
                  <%= link_to material.filename, material.url %><br/>
              <% end %>
            </p>
        <% end %>
      </div>
    </div>

    <div class="grid_300 fltr">

      <div class="frm_ribbon_right">
        <% if @deal.premium_deal? %>
            <div class="splash splash_premium">
            <span>
              <%= t("deals.index.view.premium_deal_splash_label") %>
            </span>
            </div>
        <% elsif @deal.group_deal? %>
            <div class="splash splash_group">
            <span>
              <%= t("deals.index.view.group_deal_splash_label") %>
            </span>
            </div>
        <% else %>
            <div class="splash splash_fair">
            <span>
              <%= t("deals.index.view.fair_deal_splash_label") %>
            </span>
            </div>
        <% end %>

        <% if @deal.general_discount? %>
            <p><%= t("deals.show.view.saving_label") %> <em><%= @deal.saving %></em></p>
        <% else %>
            <p><%= t("deals.show.view.price_label") %>: <em><%= as_currency(@deal.deal_price, @deal.currency) %></em>
            </p>

            <p><%= t("deals.show.view.discounted_price_label") %>:
              <em><%= as_currency(@deal.discounted_price, @deal.currency) %></em><br/>(<%= t("deals.show.view.saving_label") %> <%= @deal.saving %>
              )</p>
        <% end %>
      </div>

      <div class="frm_tiny company_info">

        <% if @deal.logo %>
            <p><%= image_tag(@deal.logo.url) %></p>
        <% end %>


        <h3><%= @deal.company_name %></h3>

        <p class="ta_l"><%= @deal.company_description.to_s.html_safe %></p>

      </div>

      <% if user_signed_in? and current_user.has_role?(:member) and @deal.requested_by?(current_user) %>
      <div class="frm_tiny">
        <div class="pdd_10">
          <ul class="elements_list">
                <%= deal_show_li(@deal.contact_name, t("deals.show.view.contact_name_label")) %>
                <%= deal_show_li(@deal.email_address, t("deals.show.view.email_address_label")) %>
                <%= deal_show_li(link_to(@deal.company_website_with_protocol, @deal.company_website_with_protocol), t("deals.show.view.company_website_label")) unless @deal.company_website.blank? %>
                <%= deal_show_li(@deal.phone_number, t("deals.show.view.phone_number_label")) %>
                <%= deal_show_li(@deal.address_line_1, t("deals.show.view.address_line_1_label")) %>
                <%= deal_show_li(@deal.address_line_2, t("deals.show.view.address_line_2_label")) %>
                <%= deal_show_li(@deal.address_line_3, t("deals.show.view.address_line_3_label")) %>
                <%= deal_show_li(@deal.zip_code, t("deals.show.view.zip_code_label")) %>
                <%= deal_show_li(@deal.country, t("deals.show.view.country_label")) %>
          </ul>
        </div>
      </div>
      <% end %>

      <% if !user_signed_in? and @deal.active? %>
          <%= bt_link_to nil, t("deals.index.view.contact_me"), "#", :onclick => "javascript:show_sign_up_or_sign_in_modal()", :class => "bt_max bt_big" %>
      <% elsif (user_signed_in? and current_user.has_role?(:member) and !@deal.requested_by?(current_user) and !@deal.awaiting_payment_requested_by?(current_user)) and @deal.active? %>
          <%= bt_link_to nil, current_user.can_request?(@deal) ? t("deals.index.view.contact_me") : t("deals.index.view.upgrade_subscription_to_get_deal"),
                         current_user.can_request?(@deal) ? new_members_lead_path(:deal_id => @deal.id) : my_profile_path(:deal_id => @deal.id), :class => "bt_max bt_big" %>
      <% end %>

      <% if @deal.group_deal? %>
          <div class="time_left_counter">
            <!--<h3><%#= t("deals.show.view.created_leads_label") %></h3>-->

            <!--<p><%#= group_deal_leads_created_and_missing(@deal) %></p>-->

            <h3><%= t("deals.show.view.time_left_label") %></h3>

            <div id="countdown" class="countdown">
              <div class="dash days_dash">
                <span class="dash_title"><%= t("deals.show.view.days") %></span>

                <div class="digit">0</div>
                <div class="digit">0</div>
              </div>
              <div class="dash hours_dash">
                <span class="dash_title"><%= t("deals.show.view.hours") %></span>

                <div class="digit">0</div>
                <div class="digit">0</div>
              </div>
              <div class="dash minutes_dash">
                <span class="dash_title"><%= t("deals.show.view.minutes") %></span>

                <div class="digit">0</div>
                <div class="digit">0</div>
              </div>
              <div class="dash seconds_dash">
                <span class="dash_title"><%= t("deals.show.view.seconds") %></span>

                <div class="digit">0</div>
                <div class="digit">0</div>
              </div>
            </div>
          </div>
      <% end %>
    </div>

    <clb/>


    <ul class="social_share">
      <li>
        <%= link_to_function image_tag('fairdeals/bt/social_email.png', :height => "20", :alt => t("deals.show.view.share_by_email")), "$('#modal_for_share_deal_by_email').dialog('open');" %>
      </li>
      <% if Rails.env != "test" %>
          <% if false %>
              <li>
                <a name="fb_share" share_url="<%= escape_uri(deal_url(:id => @deal.slug)) %>"></a>

                <!--<iframe src="http://www.facebook.com/plugins/like.php?app_id=101408449959161&amp;href=<%= escape_uri(deal_url(:id => @deal.slug)) %>&amp;send=true&amp;layout=button_count&amp;width=250&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:250px; height:21px;" allowTransparency="true"></iframe>-->
                <!--<div id="fb-root"></div>-->
                <!--<script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>-->
                <!--<fb:comments href="<%= escape_uri(deal_url(:id => @deal.slug)) %>" num_posts="2" width="500"></fb:comments>-->

              </li>
          <% end %>
          <li>
            <script src="https://platform.linkedin.com/in.js" type="text/javascript"></script>
            <script type="IN/Share" data-url="<%= deal_url(:id => @deal.slug) %>" data-counter="right"></script>
          </li>
          <li>
            <a href="https://twitter.com/share" class="twitter-share-button" data-text="<%= @deal.social_media_description %>" data-count="horizontal"><%= t("deals.show.view.tweet") %></a>
            <script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
          </li>
          <li>
            <iframe src="https://www.facebook.com/plugins/like.php?app_id=101408449959161&amp;href=<%= escape_uri(deal_url(@deal)) %>&amp;send=false&amp;layout=button_count&amp;width=250&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:250px; height:21px;" allowTransparency="true"></iframe>
          </li>
      <% end %>
    </ul>


    <div id="modal_for_share_deal_by_email" style="display:none;">
      <%= render :partial => "share_deal_by_email/new", :locals => {:deal => @deal} %>
    </div>
    <div style="width: 300px;"><%= link_to t("deals.index.view.back_to_front_page"), root_path %></div>
  </div>

  <% unless user_signed_in? %>
      <div id="modal_sign_in_or_sign_up_container_blinder" style="display:none;">
          <div id="modal_sign_in_or_sign_up_container">
              <%= render :partial => "sign_in/purchase_manager_form", :locals => {:deal => @deal, :user => User::Member.new, :url => member_accounts_path(:deal_request_id => @deal.id, :format => :js), :modal_box => true} %>
          </div>
      </div>
  <% end %>
</column-mc:>

<js:>
  <script type="text/javascript">

    <% if @deal.group_deal? %>
      jQuery(document).ready(function() {
          d = new Date();
          seconds = (<%= @deal.end_date.to_i %> - parseInt(d.getTime() / 1000));
          $('#countdown').countDown({
              targetOffset: {
                  'year':     0,
                  'month':    0,
                  'day':      0,
                  'hour':     0,
                  'min':      0,
                  'sec':      seconds
              },
              omitWeeks: true
          });
      });
    <% end %>

      jQuery(document).ready(function() {
          $('a[rel=colorbox]').colorbox();
      });

      $('#modal_for_share_deal_by_email').dialog({
          autoOpen: false,
          width: 400,
          title: '<%= t("deals.show.view.share_by_email_modal_title") %>',
          modal: true,
          buttons:
          { "<%= t("deals.show.view.send_share_by_email_button") %>": function() {
              if (validate_template_editor_fields("#modal_for_share_deal_by_email") == 0) {
                  $('#form_share_deal_by_email').submit();
                  $(this).dialog("close");
              }
          },
              "<%= t("deals.show.view.cancel") %>": function() {
                  $(this).dialog('close');
              }
          }
      });

     function show_sign_up_or_sign_in_modal(){
         $.colorbox({overlayClose: false, width: 980, height: false, inline: true, href:'#modal_sign_in_or_sign_up_container' });
     }

    $(document).ready(function() {
        select_subscription_radio_button('user_member', <%= SubscriptionPlan.free.active.only_public.for_role(:member).first.id -%>)
    });
  </script>
</js:>
