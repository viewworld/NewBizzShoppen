<column-mc:>
  <header back="true"><%= raw t("administration.users.edit.view.title_with_role", :role => @user.roles_as_text, :name => screen_name_with_company_name(@user)) %></header>

  <%= semantic_form_for @user, :url => administration_user_path, :method => :put do |form| %>
      <frm title="">
        <param:header>
          <%= bt_link_to nil, t("administration.users.edit.view.view_user_debts"), administration_invoicing_upcoming_invoices_path(:search => {:with_keyword => @user.email}), :class => "fltr" %>
          <%= bt_link_to nil, t("administration.users.edit.view.view_user_invoices"), administration_invoicing_invoices_path(:search => {:with_keyword => @user.email}), :class => "fltr" %>
          <% if @user.active_subscription.present? and @user.active_subscription.payable? and !@user.active_subscription.cancelled? %>
            <%= bt_link_to nil, t("administration.users.stop_subscription"), administration_user_path(@user, { "user_#{@user.role.to_s}".to_sym  => { :cancel_subscription => true }}), {:method => :put, :confirm => t("administration.users.index.view.delete_confirmation_message"), :class => "fltr" } %>
          <% end %>
          <% if @user.has_role?(:supplier) and !@user.has_role?(:category_supplier) %>
            <%= bt_link_to nil, t("administration.users.edit.view.change_supplier_interests_link"), edit_administration_supplier_interest_path(@user), :class => "fltr" %>
          <% end %>
          <%= bt_link_to nil, t("administration.users.edit.view.change_password_link"), new_administration_user_password_path(@user), :class => "fltr" %>
          <%= bt_link_to nil, t("administration.users.edit.view.reset_password_link"), administration_user_password_path(@user) , :method => :delete, :class => "fltr" %>
          <% if @user.has_role?(:call_centre_agent) %>
            <%= bt_link_to nil, t("administration.users.edit.view.view_created_leads"), administration_leads_path(:search => {:with_created_by => @user}), :class => "fltr" %>
          <% end %>
          <% if @user.has_role?(:category_supplier) %>
            <%= bt_link_to nil, t("administration.users.edit.view.change_to_regular_supplier"), administration_user_path(@user, "user_#{@user.role}" => {:roles_to_remove => [:category_supplier]}) , :method => :put, :class => "fltr" %>
          <% elsif @user.has_role?(:supplier) %>
            <%= bt_link_to nil, t("administration.users.edit.view.change_to_category_supplier"), administration_user_path(@user, "user_#{@user.role}" => {:roles_to_add => [:category_supplier]}) , :method => :put, :class => "fltr" %>
          <% end %>
          <% unless @user.id == current_user.id %>
            <%= bt_link_to nil, @user.locked_at.blank? ? t("administration.users.index.view.lock") : t("administration.users.index.view.unlock"), administration_user_path(@user, {"user_#{@user.role.to_s}".to_sym  => {:locked =>  @user.locked_at.blank? ? "lock" : "unlock"}}), {:method => :put, :class => "fltr" } %>
          <% end %>
        </param:header>
        <param:content>
          <%= render :partial => 'form', :locals => { :form => form }  %>
        </param:content>
        <param:actions>
          <ibt c="fltri" icon="save">
            <%= form.submit t("administration.users.edit.view.button_update_user"), :onclick => "add_unique_to_interests();select_options_to_submit('user_supplier_category_ids_');select_options_to_submit('user_#{@user.role}_unique_category_ids_');select_options_to_submit('user_category_supplier_buying_category_ids_'); " %>
          </ibt>
          <ibt c="bt_grey fltri">
            <%= button_to_function t("administration.users.edit.view.button_cancel"), "history.go(-1)" %>
          </ibt>            
        </param:actions>
      </frm>
  <% end %>

  <% if @user.subaccounts.present? %>
      <br />
      <header><%= t("administration.users.edit.view.subaccounts_list") %></header>
      <%= bulk_form do %>
        <%= render :partial => "users_table", :locals => { :users => @user.subaccounts, :subaccounts_table => true } %>
      <% end %>
  <% end %>
</column-mc:>