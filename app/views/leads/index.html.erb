<search-box:>
  <div class="search_box">
    <h2><%= t("common.search") %></h2>

    <div class="search_content">
      <%= form_for @search, :url => leads_path do |f| %>
          <fieldset class="inputs_vertical">
            <ol class="no_pdd">
              <li class="string">
                <%= f.label :with_keyword, t("customer.lead_requests.index.view.search.keyword_label") %>
                <%= f.text_field :with_keyword %>
              </li>
              <li class="select">
                <%= f.label t("leads.index.search.category_label") %>
                <%= f.select :with_category, @categories.map { |c| [c.name, c.id] }, :include_blank => true %>
              </li>
              <li class="string">
                <%= f.label t("leads.index.search.zip_code") %>
                <%= f.text_field :with_zip_code, :style => "width: 90px" %>
              </li>
              <li class="select">
                <%= f.label t("leads.index.search.country_label") %>
                <%= f.select :with_country, @countries.map { |c| [c.name, c.id] }, :include_blank => true %>
              </li>
              <li class="commit">
                <ibt c="bt_green" icon="magnify">
                  <%= submit_tag t("leads.index.search.search_button") %>
                </ibt>
                <ibt c="fltri bt_grey">
                  <%= bt_clear_filter_safe %>
                </ibt>
              </li>
            </ol>
            </fieldset>
            <fieldset class="inputs_vertical">
            <ol class="no_pdd">
              <li class="select">
                <%= f.label :with_deal_value_from, t("leads.index.search.deal_value_from_label") %>
                <%= f.select :with_deal_value_from, User::DEAL_VALUE_RANGE, {:include_blank => true} %>
              </li>
              <li class="select">
                <%= f.label :with_deal_value_to, t("leads.index.search.deal_value_to_label") %>
                <%= f.select :with_deal_value_to, User::DEAL_VALUE_RANGE, {:include_blank => true} %>
              </li>
              <li class="select">
                <%= f.label :with_created_by, t("leads.index.search.created_by") %>
                <%= f.select :with_created_by, @creators.map { |u| ["#{u.company_name}, #{u.email}", u.id] }, {:include_blank => true} %>
              </li>
              <li class="select">
                <%= f.label :with_certification_level, t("leads.index.search.certification") %>
                <%= f.select :with_certification_level, User::CERTIFICATION_LEVELS.first(4).map { |cl| [t("models.lead.certification.lvl#{cl}"), cl] }, {:include_blank => true} %>
              </li>
              <li class="select">
                <%= f.label :with_sale_limit, t("leads.index.search.sale_limit") %>
                <%= f.select :with_sale_limit, (1..10).to_a, {:include_blank => true} %>
              </li>
              <li class="select">
                <%= f.label :with_hotness, t("leads.index.search.hotness") %>
                <%= f.select :with_hotness, (0..2).to_a.map { |hl| [t("models.lead.hotness.lvl#{hl}"), hl] }, {:include_blank => true} %>
              </li>
            </ol>
          </fieldset>
      <% end %>
    </div>
  </div>
</search-box:>

<column-mc:>

  <header back="true"><%= leads_listing_header %><%= " #{t("leads.index.header_for")} #{@category.name}" if @category %></header>

  <% unless blurb(:blurb_leads_listing).blank? %>
      <div class="pdd_10 no_pdd_lr"><%= blurb(:blurb_leads_listing) %></div>
  <% end %>

  <% if @leads.empty? %>
      <%= blank_state_message %>
  <% else %>
      <%= form_tag bulk_action_path do %>
          <%= leads_listing @leads, :show_checkboxes => (user_signed_in? and current_user.has_any_role?(:customer, :lead_buyer, :lead_user))  do |blocks| %>

              <% blocks.tools do |lead| %>
                  <% if user_signed_in? %>
                      <% if current_user.has_role?(:lead_buyer) %>
                          <!-- TODO Should not be here - should be in buyer scope! ... Oh rly? -->
                          <!-- We should change it - ask RB! -->
                          <%= bt_link_to :cart, current_user.big_buyer? ? t("leads.index.buy_lead") : t("leads.index.add_to_cart_link"), buyers_cart_items_path(:id => lead.id), :method => :post, :class => "default_action" %>
                          <%= hidden_field_tag :confirmation_message, current_user.big_buyer? ? t("leads.index.buy_lead_confirm_msg") : t("leads.index.add_to_cart_lead_confirm_msg"), :class => "default_action_confirmation_msg" %>
                      <% elsif current_user.has_role?(:lead_user) %>
                          <%= hidden_field_tag :confirmation_message, t("leads.index.request_lead_confirm_msg"), :class => "default_action_confirmation_msg" %>
                          <%= bt_link_to nil, t("leads.index.request_lead"), lead_users_lead_requests_path(:lead_id => lead.id), :method => :post, :class => "default_action" %>
                      <% end %>
                  <% else %>
                      <%= bt_link_to :cart, t("leads.index.add_to_cart_link"), buyers_cart_items_path(:id => lead.id, :requested_url =>  request.fullpath), :method => :post, :class => "default_action" %>
                      <%= hidden_field_tag :confirmation_message, t("leads.index.add_to_cart_lead_confirm_msg"), :class => "default_action_confirmation_msg" %>
                  <% end %>
                  <% if lead.buyout_possible_for?(current_user) %>
                      <%= bt_link_to :cart, t("leads.index.add_to_cart_buyout_link"), buyers_cart_items_path(:id => lead.id, :requested_url =>  request.fullpath, :buyout => true), :method => :post, :class => "default_action" %>
                      <%= hidden_field_tag :confirmation_message, t("leads.index.add_to_cart_buyout_lead_confirm_msg"), :class => "default_action_confirmation_msg" %>
                  <% end %>
              <% end %>


              <% if user_signed_in? && (current_user.has_role?(:customer) || current_user.has_role?(:lead_user)) %>
                  <% blocks.bottom do %>
                      <% if current_user.has_role?(:customer) or current_user.has_role?(:lead_buyer) %>
                          <%= hidden_field_tag :route_to, "/buyers/bulk_cart_items" %>
                          <ibt>
                            <%= submit_tag current_user.big_buyer? ? t("leads.index.button_bulk_buy_leads") : t("leads.index.button_bulk_create_cart_item") %>
                          </ibt>
                      <% elsif current_user.has_role?(:lead_user) %>
                          <%= hidden_field_tag :route_to, "/lead_users/bulk_lead_requests" %>
                          <ibt>
                            <%= submit_tag t("leads.index.button_bulk_create_lead_request") %>
                          </ibt>
                      <% end %>
                  <% end %>
              <% end %>

          <% end %>
      <% end %>
  <% end %>
</column-mc:>
